<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Fission.Internal.MonadDB</span><span>
</span><span id="line-2"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="Fission.Internal.MonadDB.Types.html"><span class="hs-identifier">Fission.Internal.MonadDB.Types</span></a></span><span>
</span><span id="line-3"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="Fission.Internal.MonadDB.Class.html"><span class="hs-identifier">Fission.Internal.MonadDB.Class</span></a></span><span>
</span><span id="line-4"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Fission.Internal.MonadDB.html#runDBNow"><span class="hs-identifier">runDBNow</span></a></span><span>
</span><span id="line-5"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Fission.Internal.MonadDB.html#getInner"><span class="hs-identifier">getInner</span></a></span><span>
</span><span id="line-6"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Fission.Internal.MonadDB.html#ensureEntity"><span class="hs-identifier">ensureEntity</span></a></span><span>
</span><span id="line-7"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Fission.Internal.MonadDB.html#ensureEntityM"><span class="hs-identifier">ensureEntityM</span></a></span><span>
</span><span id="line-8"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Logger</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Time</span></span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Database.Esqueleto</span></span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">RIO.Time</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">RIO</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">logError</span></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Fission.Internal.MonadDB.Types.html"><span class="hs-identifier">Fission.Internal.MonadDB.Types</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Fission.Internal.MonadDB.Class.html"><span class="hs-identifier">Fission.Internal.MonadDB.Class</span></a></span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span id="local-6989586621680279179"><span id="local-6989586621680279180"><span id="local-6989586621680279181"><span class="annot"><a href="Fission.Internal.MonadDB.html#runDBNow"><span class="hs-identifier hs-type">runDBNow</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadTime</span></span><span> </span><span class="annot"><a href="#local-6989586621680279181"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Fission.Internal.MonadDB.Class.html#MonadDB"><span class="hs-identifier hs-type">MonadDB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680279180"><span class="hs-identifier hs-type">trans</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680279181"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680279180"><span class="hs-identifier hs-type">trans</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680279179"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680279181"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680279179"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-22"></span><span id="runDBNow"><span class="annot"><span class="annottext">runDBNow :: (UTCTime -&gt; trans a) -&gt; m a
</span><a href="Fission.Internal.MonadDB.html#runDBNow"><span class="hs-identifier hs-var hs-var">runDBNow</span></a></span></span><span> </span><span id="local-6989586621680279178"><span class="annot"><span class="annottext">timeTransaction :: UTCTime -&gt; trans a
</span><a href="#local-6989586621680279178"><span class="hs-identifier hs-var">timeTransaction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-23"></span><span>  </span><span id="local-6989586621680279177"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621680279177"><span class="hs-identifier hs-var">now</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m UTCTime
forall (m :: * -&gt; *). MonadTime m =&gt; m UTCTime
</span><span class="hs-identifier hs-var">currentTime</span></span><span>
</span><span id="line-24"></span><span>  </span><span class="annot"><span class="annottext">trans a -&gt; m a
forall (transaction :: * -&gt; *) (m :: * -&gt; *) a.
MonadDB transaction m =&gt;
transaction a -&gt; m a
</span><a href="Fission.Internal.MonadDB.Class.html#runDB"><span class="hs-identifier hs-var">runDB</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UTCTime -&gt; trans a
</span><a href="#local-6989586621680279178"><span class="hs-identifier hs-var">timeTransaction</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621680279177"><span class="hs-identifier hs-var">now</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span id="local-6989586621680279193"><span id="local-6989586621680279195"><span id="local-6989586621680279196"><span class="annot"><a href="Fission.Internal.MonadDB.html#ensureEntity"><span class="hs-identifier hs-type">ensureEntity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="annot"><a href="#local-6989586621680279196"><span class="hs-identifier hs-type">err</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadLogger</span></span><span> </span><span class="annot"><a href="#local-6989586621680279195"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621680279195"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680279196"><span class="hs-identifier hs-type">err</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621680279193"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680279195"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680279193"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-27"></span><span id="ensureEntity"><span class="annot"><span class="annottext">ensureEntity :: err -&gt; Maybe a -&gt; m a
</span><a href="Fission.Internal.MonadDB.html#ensureEntity"><span class="hs-identifier hs-var hs-var">ensureEntity</span></a></span></span><span> </span><span id="local-6989586621680279174"><span class="annot"><span class="annottext">err :: err
</span><a href="#local-6989586621680279174"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-28"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">err -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwM</span></span><span> </span><span class="annot"><span class="annottext">err
</span><a href="#local-6989586621680279174"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-29"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680279172"><span class="annot"><span class="annottext">x :: a
</span><a href="#local-6989586621680279172"><span class="hs-identifier hs-var">x</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680279172"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span id="local-6989586621680279169"><span id="local-6989586621680279170"><span id="local-6989586621680279171"><span class="annot"><a href="Fission.Internal.MonadDB.html#ensureEntityM"><span class="hs-identifier hs-type">ensureEntityM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="annot"><a href="#local-6989586621680279171"><span class="hs-identifier hs-type">err</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadLogger</span></span><span> </span><span class="annot"><a href="#local-6989586621680279170"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621680279170"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680279171"><span class="hs-identifier hs-type">err</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680279170"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621680279169"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680279170"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680279169"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-32"></span><span id="ensureEntityM"><span class="annot"><span class="annottext">ensureEntityM :: err -&gt; m (Maybe a) -&gt; m a
</span><a href="Fission.Internal.MonadDB.html#ensureEntityM"><span class="hs-identifier hs-var hs-var">ensureEntityM</span></a></span></span><span> </span><span id="local-6989586621680279168"><span class="annot"><span class="annottext">err :: err
</span><a href="#local-6989586621680279168"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span id="local-6989586621680279167"><span class="annot"><span class="annottext">maybeEntity :: m (Maybe a)
</span><a href="#local-6989586621680279167"><span class="hs-identifier hs-var">maybeEntity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">err -&gt; Maybe a -&gt; m a
forall err (m :: * -&gt; *) a.
(Exception err, MonadLogger m, MonadThrow m) =&gt;
err -&gt; Maybe a -&gt; m a
</span><a href="Fission.Internal.MonadDB.html#ensureEntity"><span class="hs-identifier hs-var">ensureEntity</span></a></span><span> </span><span class="annot"><span class="annottext">err
</span><a href="#local-6989586621680279168"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe a -&gt; m a) -&gt; m (Maybe a) -&gt; m a
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">m (Maybe a)
</span><a href="#local-6989586621680279167"><span class="hs-identifier hs-var">maybeEntity</span></a></span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span id="local-6989586621680279164"><span id="local-6989586621680279165"><span class="annot"><a href="Fission.Internal.MonadDB.html#getInner"><span class="hs-identifier hs-type">getInner</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680279165"><span class="hs-identifier hs-type">model</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680279164"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Entity</span></span><span> </span><span class="annot"><a href="#local-6989586621680279165"><span class="hs-identifier hs-type">model</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680279164"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-35"></span><span id="getInner"><span class="annot"><span class="annottext">getInner :: (model -&gt; a) -&gt; Entity model -&gt; a
</span><a href="Fission.Internal.MonadDB.html#getInner"><span class="hs-identifier hs-var hs-var">getInner</span></a></span></span><span> </span><span id="local-6989586621680279163"><span class="annot"><span class="annottext">accessor :: model -&gt; a
</span><a href="#local-6989586621680279163"><span class="hs-identifier hs-var">accessor</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Entity</span></span><span> </span><span class="hs-identifier">_</span><span> </span><span id="local-6989586621680279161"><span class="annot"><span class="annottext">model :: model
</span><a href="#local-6989586621680279161"><span class="hs-identifier hs-var">model</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">model -&gt; a
</span><a href="#local-6989586621680279163"><span class="hs-identifier hs-var">accessor</span></a></span><span> </span><span class="annot"><span class="annottext">model
</span><a href="#local-6989586621680279161"><span class="hs-identifier hs-var">model</span></a></span><span>
</span><span id="line-36"></span></pre></body></html>